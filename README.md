# Spring MVC - Udemy course
To the Spring Framework Udemy Course by Neil Alishev

https://www.udemy.com/course/spring-alishev/learn/lecture/31009318

<h2>Lesson 32. "Id auto generation: Sequences, id int GENERATED BY DEFAULT AS IDENTITY"</h2>

To identify rows of tables by unique key  we obviously should use  it's <b>id column</b>.
Before we assigned values for <b>id column</b> however in javacode.
Let's see what's in the table. Go to the console (<b>Ctrl+Shift+F10</b>).

<u>Command</u>:

    SELECT * FROM person

<u>Result</u>:

    4,Sergei;),46,Sergei@yahoo.com
    2,Bobby,25,bob@gmail.com
    6,Roberto,24,roberto@gmail.com
    7,New Person,107,new.person@gmail.com
    311,Tom-311,31,tom311@gmail.com
    338,Tom-338,21,tom338@gmail.com
    395,Tom-395,39,tom395@gmail.com
    10,Tom-10,41,tom10@gmail.com

Everything is seen to be ok. 
But a reliable generation is implemented with the entity <b>Sequence</b>.

<u>Command</u>:

    CREATE SEQUENCE first_sequence

<u>Result</u>:

    first_db@localhost
        first_db
            public
                tables      1
                    person
                sequences   1
                    first_sequence

So there will appear folder <b>sequences</b> with our sequence "<b>first_sequence"</b>

To generate a new id we should use a command <b>SELECT NEXTVAL('<sequence_name>')</b>:

<u>Command</u>:

    SELECT NEXTVAL('first_sequence');
    SELECT NEXTVAL('first_sequence');
    SELECT NEXTVAL('first_sequence')

<u>Result</u>:

    1
    2
    3

So that each time we execute <b>SELECT NEXTVAL</b> with the same sequence we will get
the next number greater than previous one by one, i.e. incremented.

Let's remove our sequence:

<u>Command</u>:

    DROP SEQUENCE first_sequence

<u>Result</u>:

    first_db@localhost
        first_db
            public
                tables      1
                    person

Let's improve our <b>table person</b> so that the <b>column id</b> will be linked 
with a <b>sequence</b>. But first we should remove our existing table where <b>id</b> is
a just ordinary <b>int</b>:

<u>Command</u>:

    DROP TABLE person

<u>Result</u>:

    first_db@localhost
        first_db
                
<h3>PostgreS keyword <u>SERIAL</u></h3>

Let's create the <b>table person</b> where <id> will be created <b>automatically</b>:

<u>Command</u>:

    CREATE TABLE person(
        id SERIAL,
        name varchar,
        age int,
        email varchar
    )
<u>Result</u>:

    first_db@localhost
        first_db
            public
                tables      1
                    person
                sequences   1
                    person_id_seq


<b>SERIAL</b> is a <b>pseudo type</b>, a <i>syntax sugar</i>, 
but <b>Postgres</b> will create a corresponding <b>sequence</b> named 
<b><table-name>_<column-name>_seq</b>, in our case it will be a sequence
named <b>person_id_seq</b>. 
<br>Each time the <b>INSERT INTO person</b>-command will be executed also
the command <b>SELECT NEXTVAL('person_id_seq')</b> will be executed and its value will be
assigned as a value for the comlumn <b>id</b>  for each new row in the <b>table person</b>:
<u>Command</u>:

    INSERT INTO person(name, age, email)  values ('Tom', 30, 'test@gmail.com');
    INSERT INTO person(name, age, email)  values ('Tom123', 30, 'test123@gmail.com');
    INSERT INTO person(name, age, email)  values ('Bob', 35, 'bob123@gmail.com');

    SELECT * FROM person

<u>Result</u>:

    1,Tom,30,tom@gmail.com
    2,Tom123,30,tom@gmail.com
    3,Bob,35,bob123@gmail.com

<h3>id int GENERATED BY DEFAULT AS IDENTITY</h3>

A new syntax is in use since <b>PostgreS.10</b>:

    CREATE TABLE Person2(
        id int GENERATED BY DEFAULT AS IDENTITY,
        name varchar
    )

<u>This syntax is a de-facto standard for SQL</u> and e.g. used in Oracle DB,
and we will use this syntax.

<u>Result</u>:
        
    first_db@localhost
        first_db
            public
                tables      2
                    person
                    person2
                sequences   2
                    person2_id_seq
                    person_id_seq
                    

Let's check if it works appropriately:
<u>Command</u>:

    INSERT INTO person2(name)  values ('Tom');
    INSERT INTO person2(name)  values ('Tom123');
    
    SELECT * FROM person2

<u>Result</u>:

    1,Tom
    2,Tom123

<h3>Recoding the class <u>dao.PersonDAO</u></h3>

Instead of an existing <i>primitive</i> version of code:

    public void save(Person person) {
        jdbcTemplate.update("INSERT INTO person VALUES (?,?,?,?)", 
            person.getId(), person.getName(), person.getAge(), person.getEmail());
    }

We will write a new <i>prodigy</i> one:

    public void save(Person person) {
        jdbcTemplate.update("INSERT INTO person(name, age, email) VALUES (?,?,?)", 
            person.getName(), person.getAge(), person.getEmail());
    }

where  <b>id</b> will be generated automatically.

:)
