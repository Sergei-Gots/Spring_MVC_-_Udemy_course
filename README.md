# Spring MVC - Udemy course
To the Spring Framework Udemy Course by Neil Alishev

https://www.udemy.com/course/spring-alishev/learn/lecture/31009684

<h2>Lesson 41. "DB Cascade"</h2>

When we have some relation between tables it will cause to some
complexities by some operations.
    E.g. we have two tables with the relationship <b>"One-To-Many"</b>:
let it be tables <b>'Person'</b> and <b>'Ordered_item'</b>. So that one
<b>person can have some orders</b>:

    CREATE TABLE Person (
        id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name varchar(100) NOT NULL,
        age int CHECK (age >=0 )
    );

    CREATE TABLE "Order" (
        order_id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        user_id int REFERENCES Person(id),
        item_name varchar(100) NOT NULL
    );


Note: it seems, that word 'order' is a reserved keyword in PostgreSQL.
And in order:) to use this word as a name for our table we should put <b>Order</b>-word
in <b>quotation marks</b> like this: <b>"Order"</b>.
And if we try creating table is a standard way like:

    CREATE TABLE Order (...);

We will get the next error message:

    [42601] ERROR: Syntax Error (near "Order"), Postition:14

Ok. So now we have tables <b>'Person'</b>  and <b>'Order'</b>:)
Let's add a person and their order in our table:

    INSERT INTO Person(name, age) VALUES ('Tom', 30);
    INSERT INTO "Order"(user_id, item_name) VALUES(1, 'Iphone');

Now if we try deleting the person:

    DELETE FROM Person WHERE id=1;

We will get the error message:

    [23503] ERROR: UPDATE or DELETE on table "person" violates FK constraint "Order_user_id_fkey" on the table "Order"
    Details: Key (id)=(1) is still referenced from table "Order".

And it is so because the <b>DB Cascade</b> <b>RESTRICT</b> is applied by default.

<h3>Database CASCADE Types</h3>

The <b>DB CASCADE Type</b> is assigned by assigning field 
after the keyword <b>REFERENCES</b> by creating table:

    CREATE TABLE <TableName> (
        ...
            <fieldName> <fieldType> REFERENCES [ON DELETE <CASCADE_TYPE by default = RESRTRICT>]
        ...
    );


<b>DB CASCADE Types are:</b>

<li><b>RESTRICT</b> - assigned by default. Prohibits DELETE with a key which
is still referenced from a child table. Also prohibits UPDATE if it causes
to change such a key;
<li><b>CASCADE</b> - causes cascading DELETE on all tables referring to
current table by this field.
<li><b>SET NULL</b> - sets <b><null></null></b> values into referring
field on all child tables with the value of key supposed to be deleted.

<p>
    Ok. Let's drop our tables:

        DROP TABLE Person;
        DROP TABLE "Order";
</p>
    It will cause again an error:

    first_db.public> DROP TABLE Person
    [2022-11-26 04:53:16] [2BP01] ERROR: Cannot drop table person because other objects depend on it.
    [2022-11-26 04:53:16] DETAILS: constaint Order_user_id_fkey on table "Order" depends on table person
    [2022-11-26 04:53:16] TIP: Use DROP ... CASCADE to drop the dependent objects too.

<p>So we can change either drop order or use <b>DROP ... CASCADE</b> command:
        
        DROP TABLE "Order";
        DROP TABLE "Person";

Now let's create the same tables but using <b>Cascade</b>-definition:

    CREATE TABLE Person (
        id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name varchar(100) NOT NULL,
        age int CHECK (age >= 0)
    );

    CREATE TABLE "Order" (
        order_id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        user_id int REFERENCES Person(id)
            ON DELETE CASCADE,
        item_name varchar(100) NOT NULL
    );

Now by <b>DELETE</b> person corresponding orders will also be deleted.
Let's perform inserting data to the tables:

    INSERT INTO Person(name, age) VALUES ('Tom', 30);
    INSERT INTO "Order"(user_id, item_name) VALUES(1, 'Iphone');

Now let's try deleting the person:

    DELETE FROM Person WHERE id=1;

And it will be successfully affected. And if we try getting data
from table "Order"

    SELECT * FROM "Order";

we will get empty table.

The last strategy is using <b>SET NULL<b> as we <b>DB-Cascade-Type</b>.
Let's drop table "Order":


    DROP TABLE "Order";

Now let's create it with the <b>Cascade</b>-type <b>SET NULL</b>:

    CREATE TABLE "Order" (
        order_id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        user_id int REFERENCES Person(id)
            ON DELETE SET_NULL,
        item_name varchar(100) NOT NULL
    );

Now by <b>DELETE</b> person corresponding orders will have <b>null</b>
instead of deleted FK-value.
Let's perform inserting data to the tables:

    INSERT INTO Person(name, age) VALUES ('Tom', 30);
    INSERT INTO "Order"(user_id, item_name) VALUES(2, 'Iphone');

Note: we use as <b>user_id</b>-value <b>2</b> because we didn't drop
the table <b>'Person'</b> and <b>id</b> there is <b>GENERATED BY DEFAULT
AS IDENTITY</b> and so that was incremented since first INSERT.
Now let's try deleting the person:

    DELETE FROM Person WHERE id=2;

And it will be successfully affected. And if we try getting data
from table "Order"

    SELECT * FROM "Order";

we will get:

    1,<null>,Iphone

So that now the order exists, but belongs to nobody:)


