# Spring MVC - Udemy course
To the Spring Framework Udemy Course by Neil Alishev

https://www.udemy.com/course/spring-alishev/learn/lecture/31009362

<h2>Lesson 32. "Constraints: NOT NULL, UNIQUE, PRIMARY KEY, CHECK"</h2>

Our table <b>person</b> has 4 columns. And these columns don't have any constraints on
their content. So that we can assign as a value <b>null</b> and we can have a person
with null-<b>name</b> or have a negative value for the field <b>age</b>
and even have a person without a specified <b>id</b> or we can change a value for the
field <b>id</b> so that we will be able to have different people with the same id.
To prevent such collisions we will use <b>constraints</b>.
<br>The most popular constraints are:
<li>NOT NULL
<li>UNIQUE
<li>PRIMARY KEY (<b>PK</b>)
<li>FOREIGN KEY (<b>FK</b>)
<li>CHECK

<p><b>PRIMARY KEY PK</b> unifies <b>NOT NULL</b> and <b>UNIQUE</b> constraints and it is
the constraint that will be used for <b>id</b>-column. Because <b>id</b> is obviously unique
and is not empty.
<p>The constraint <b>CHECK</b> will be appropriate for the column <b>age</b> to be sure
that an input value won't be <0.

<h3>Is it normal to have DOUBLE VALIDATION?</h3>

We have already a validation in java-code made with annotation, e.g. for the field <b>age</b> we have:

    @Min(value=0, message = "Age should be equal or greater than 0")
    private int age;

And we will have also a validation on a database level:

    age int CHECK ( age > 0 )

It is normal to have such a double validation. On one hand it will protect stronger
from incorrect input data, on the other hand we make validation on the application level
in java code to draw in appropriate and user-friendly way error messages in a forms for end-user,
and again, on the level of database it will make impossible to technically input incorrect values.

<h3>Recreating table with constraints</h3>

First we should drop the table <b>person</b>:
<br>
<br>
<u>Command</u>:

    DROP TABLE person

Then we create the table <b>person</b> already with constraints:
<br>
<br>
<u>Command</u>:
    
    CREATE TABLE person(
        id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name varchar NOT NULL,
        age int CHECK ( age > 0 ),
        email varchar UNIQUE
    );

After that we can check if our constraints work. 
<p>Let's try to create with the web-app <b>two persons</b> with the same <b>e-mail</b>
e.g. <b>test@mail.com</b>. After we will be trying to submit the second person,
we will get the next result in browser:

    HTTP Status 500 – Internal Server Error
    Type Exception Report

    Message Request processing failed; nested exception is org.springframework.dao.DuplicateKeyException: PreparedStatementCallback; SQL [INSERT INTO person(name, age, email) VALUES (?,?,?)]; ОШИБКА: повторяющееся значение ключа нарушает ограничение уникальности "person_email_key"

    Description The server encountered an unexpected condition that prevented it from fulfilling the request.

    Exception

    org.springframework.web.util.NestedServletException: Request processing failed; nested exception is org.springframework.dao.DuplicateKeyException: PreparedStatementCallback; SQL [INSERT INTO person(name, age, email) VALUES (?,?,?)]; ОШИБКА: повторяющееся значение ключа нарушает ограничение уникальности "person_email_key"
    Подробности: Ключ "(email)=(test@mail.com)" уже существует.; nested exception is org.postgresql.util.PSQLException: ОШИБКА: повторяющееся значение ключа нарушает ограничение уникальности "person_email_key"
    Подробности: Ключ "(email)=(test@mail.com)" уже существует.
    ....

We didn't have a validation for this case in java code on a form and because of it get such
a deep explaining for this error given by the data base server. But it prevented our
database from inserting incorrect data in it.

:)
